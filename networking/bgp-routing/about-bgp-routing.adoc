:_mod-docs-content-type: ASSEMBLY
[id="about-bgp-routing"]
= About BGP routing
include::_attributes/common-attributes.adoc[]
:context: about-bgp-routing

toc::[]

This feature provides native BGP routing capabilities for the OVN-Kubernetes network plugin on bare-metal clusters.

**Summary of Use Cases for BGP Integration with OVN-Kubernetes**

Integrating BGP into OVN-Kubernetes addresses several key requirements to enhance network functionality and performance within OpenShift clusters:

1. **Importing Routes from the Provider Network**: Currently, users must manually configure routes on each node using local gateway mode and tools like NM State, which is cumbersome and not dynamic. BGP integration allows OVN-Kubernetes to import routes directly from the provider network, eliminating manual configurations and enabling dynamic routing updates in response to network changes.

2. **Exporting Routes into the Provider Network**: While MetalLB advertises load balancer IPs via BGP, there's a need to advertise pod IPs directly to the provider network for better integration with third-party load balancers. BGP integration enables OVN-Kubernetes to export pod subnets or addresses, allowing external devices to reach pods directly without relying on custom operators to manage routing.

3. **Datapath Performance Enhancement**: By leveraging the underlay network through BGP, tunnel encapsulation can be bypassed, reducing packet overhead and increasing throughput. This direct use of the underlay network enhances performance for applications requiring high bandwidth.

4. **Multi-homing, Link Redundancy, and Fast Convergence**: BGP supports multi-homing with Equal-Cost Multi-Path (ECMP) routing, providing layer 3 failover capabilities. Coupled with Bidirectional Forwarding Detection (BFD), BGP can detect link failures within milliseconds, allowing rapid rerouting of traffic. This is crucial in topologies where nodes have multiple NICs connected to different BGP routers, ensuring high availability and network resilience.

[id="prerequisites_{context}"]
== Prerequisites

Use of advanced routing features requires that you have properly configured BGP for your network infrastructure. Outages or misconfigurations of your network infrastructure might cause disruptions to your cluster network.

== Cluster Network Operator configuration

The Cluster Network Operator API exposes several fields to configure advanced routing.

`spec.additionalRoutingCapabilities`
`spec.defaultNetwork.ovnKubernetesConfig.routeAdvertisements`

> In the above API changes, AdvancedRouting is used in order to signal to CNO to deploy FRR and FRR-K8S, while the RouteAdvertisements API will enable the route advertisement feature within OVN-Kubernetes. AdvancedRouting may be used without enabling RouteAdvertisements, such as for MetalLb functionality. However, when enabling RouteAdvertisements it is required to enable FRR as the AdvancedRouting provider.

> Note, at this time there is no support for a nodeSelector to choose which nodes to deploy AdvancedRouting to. In the future this may change, but for now when enabling a provider, it will be enabled on all nodes.

== Compatibility with other networking features

Multiple external gateways::
--
When used with multiple external gateways (MEG) as implemented with the `AdminPolicyBasedExternalRoute` CR, there are several potential interactions:

- When BGP discovers routes to next hops, there can overlap with gateways detected by MEG. If BFD is configured with `nextHops.static.bfdEnabled`, overlapping routes are ignored by OVN-Kubernetes. If BFD is configured in FRR, overlapping routes are immediately purged.
- When MEG is configured for a namespace targeted by a `RouteAdvertisements` CR network selector, an external gateway capable of BGP peering may learn of the pod subnet routes automatically.
--

EgressIPs::
Works with EgressIPs. Moreover these IP addresses are advertised with BGP, so egress IP nodes no longer need to be on the same layer 2 network segment.

Services::
Works in concert with the MetalLB Operator to advertise services to the provider network.

Egress service::
Full support.

Egress firewall::
Full support.

Egress QoS::
Full support.

Network policies::
Full support.

Direct pod ingress::
Full support for the default cluster network and user-defined networks.


== Considerations for use with the MetalLB Operator

The MetalLB Operator is installed as an add-on to the cluster. Because both BGP routing and MetalLB rely on FRR-K8s for BGP support, enabling additional routing capabilities automatically installs FRR-K8s. When installed, the MetalLB Operator uses the FRR-K8s daemon installed by this feature.

== BGP routing custom resources

The following custom resources are used to configure BGP routing:

`RouteAdvertisements`::
This custom resource defines the advertisements for the BGP routing. From this CR the OVN-Kubernetes controller generates a `FRRConfiguration` object that configures the FRR daemon to advertise the routes. This CR is cluster scoped.

`FRRConfiguration`::
This custom resource defines the FRR configuration for the BGP routing. This CR is namespaced.

== BGP implementation

TBD

[id="nw-bgp-routing-routeadvertisements-object_{context}"]
=== RouteAdvertisements configuration object

The fields for the `RouteAdvertisements` custom resource are described in the following table:

////
TODO: `advertisements` is possibly going to change to a list of strings.
////

.`RouteAdvertisements` object
[cols=".^2,.^2,.^6",options="header"]
|====
|Field|Type|Description

|`metadata.name`
|`string`
|Specifies the name of the `RouteAdvertisements` object.

|`advertisements.egressIP`
|`boolean`
|Specifies whether the network EgressIPs are advertised.

|`advertisements.podNetwork`
|`boolean`
|Specifies whether the pod network routes are advertised.

|`frrConfigurationSelector`
|`object`
|Optional: Determines which FRRConfigurations the OVN-Kubernetes driven FRRConfigurations will be based on. When omitted, all FRRConfigurations will be considered.

|`networkSelector`
|`object`
|Optional: Specifies which network routes to advertise. When omitted, advertises the default cluster network routes. Only a single network may be selected by a `RouteAdvertisements` CR. If multiple CRs select the same network, OVN-Kubernetes logs an error to the CR status and the configuration is not applied.

|`nodeSelector`
|`object`
|Optional: Limits the advertisements to selected nodes. When omitted, selects all nodes.

|`targetVRF`
|`string`
|Determines which virtual routing and forwarding (VRF) target to advertise the routes in.

|====

== Examples advertising pod IP addresses with BGP

The following examples describe several different configurations for advertising pod IP addresses with BGP. Each example relies upon the following `FRRConfiguration` object, which OVN-Kubernetes generated from a `RouteAdvertisements` CR:

.`FRRConfiguration` CR generated by OVN-Kubernetes
[source,yaml]
----
apiVersion: frrk8s.metallb.io/v1beta1
kind: FRRConfiguration
metadata:
  creationTimestamp: "2024-06-11T14:22:37Z"
  generation: 1
  name: metallb-ovn-worker
  namespace: metallb-system
  resourceVersion: "1323"
  uid: 99b64be3-4f36-4e0b-8704-75aa5182d89f
  labels:
    routeAdvertisements: default
spec:
  bgp:
    routers:
    - asn: 64512
      neighbors:
      - address: 172.18.0.5
        asn: 64512
        disableMP: false
        holdTime: 1m30s
        keepaliveTime: 30s
        passwordSecret: {}
        port: 179
        toAdvertise:
          allowed:
            mode: filtered
        toReceive:
          allowed:
            mode: filtered
  nodeSelector:
    matchLabels:
       kubernetes.io/hostname: ovn-worker
----

The OVN-Kubernetes controller checks if this `FRRConfiguration` CR applies to its node, `ovn-worker`. For these examples a user-defined network named `blue` exists with a network of `10.0.0.0/16` and a matching VRF device exists in the Linux host. The slice of this supernet allocated to node `ovn-worker` is `10.0.1.0/24`.

=== Advertising pod IPs from a user-defined network over BGP

In this scenario, the blue user-defined network is exposed to the external network so that the pod IP addresses are reachable on the external network.

**Diagram 1**

In this configuration, two separate user-defined networks are defined. The red network covers the `10.0.0.0/24` subnet and the blue network covers the `10.0.1.0/24` subnet.

The following `RouteAdvertisements` CR describes the configuration for the blue tenant:

.`RouteAdvertisements` CR for the blue tenant
[source,yaml]
----
apiVersion: k8s.ovn.org/v1
kind: RouteAdvertisements
metadata:
  name: default
spec:
  advertisements:
    podNetwork: true
  networkSelector:
    matchLabels:
      k8s.ovn.org/metadata.name: blue
  nodeSelector:
    matchLabels:
      kubernetes.io/hostname: ovn-worker
  frrConfigurationSelector:
    matchLabels:
      routeAdvertisements: default
----

When the OVN-Kubernetes controller sees this `RouteAdvertisements` CR, it generates a `FRRConfiguration` object that configures the FRR daemon to advertise the routes.

.`FRRConfiguration` CR generated by OVN-Kubernetes
[source,yaml]
----
apiVersion: frrk8s.metallb.io/v1beta1
kind: FRRConfiguration
metadata:
  name: route-advertisements-blue
  namespace: metallb-system
spec:
  bgp:
    routers:
    - asn: 64512
      vrf: blue
      prefixes:
      - 10.0.1.0/24
    - asn: 64512
      neighbors:
        - address: 172.18.0.5
          asn: 64512
          toAdvertise:
            allowed:
              prefixes:
              - 10.0.1.0/24
  raw:
    rawConfig: |-
      router bgp 64512
      address-family ipv4 unicast
        import vrf blue
        exit-address-family
      router bgp 64512 vrf blue
      address-family ipv4 unicast
        import vrf default
        exit-address-family
  nodeSelector:
    matchLabels:
      kubernetes.io/hostname: ovn-worker
----

The generated `FRRConfiguration` object configures the subnet `10.0.1.0/24`, which belongs to VRF blue, is imported into the default VRF and advertised to the `172.18.0.5` neighbor. Because the `targetVRF` uses the default value, the routes are leaked and advertised in the default VRF. Additionally, routes are imported from the default VRF into the blue VRF.

=== Advertising pod IPs from a user-defined network over BGP with VPN

In this scenario, a VLAN interface attached to a VRF device, is associated with the blue network in isolation to the external PE router. This setup provides a _VRF lite_ design where FRR-K8S is leveraged to advertise the blue network over only the corresponding VRF/VLAN link to the next hop PE router. The red tenant uses the same configuration.

[NOTE]
====
This approach is available only when using OVN-Kubernetes local gateway mode by setting `routingViaHost=true`.
====

**Diagram 2**

In the following configuration, an additional `FRRConfiguration` CR configures peering with the PE router on the blue and red VLANs:

.`FRRConfiguration` CR manually configured for BGP VPN setup
[source,yaml]
----
apiVersion: frrk8s.metallb.io/v1beta1
kind: FRRConfiguration
metadata:
  name: vpn-ovn-worker
  namespace: metallb-system
  labels:
    routeAdvertisements: vpn-blue-red
spec:
  bgp:
    routers:
    - asn: 64512
      vrf: blue
      neighbors:
      - address: 182.18.0.5
        asn: 64512
        disableMP: false
        holdTime: 1m30s
        keepaliveTime: 30s
        passwordSecret: {}
        port: 179
        toAdvertise:
          allowed:
            mode: filtered
        toReceive:
          allowed:
            mode: filtered
    - asn: 64512
      vrf: red
      neighbors:
      - address: 192.18.0.5
        asn: 64512
        disableMP: false
        holdTime: 1m30s
        keepaliveTime: 30s
        passwordSecret: {}
        port: 179
        toAdvertise:
          allowed:
            mode: filtered
        toReceive:
          allowed:
            mode: filtered
----


The following `RouteAdvertisements` CR describes the configuration for the blue and red tenants:

.`RouteAdvertisements` CR for the blue and red tenants
[source,yaml]
----
apiVersion: k8s.ovn.org/v1
kind: RouteAdvertisements
metadata:
  name: default
spec:
  targetVRF: auto
  advertisements:
    podNetwork: true
  networkSelector:
    matchExpressions:
    - { key: k8s.ovn.org/metadata.name, operator: In, values: [blue,red] }
  nodeSelector:
    matchLabels:
      kubernetes.io/hostname: ovn-worker
  frrConfigurationSelector:
    matchLabels:
      routeAdvertisements: vpn-blue-red
----

In the `RouteAdvertisements` CR the `targetVRF` is set to `auto` so that advertisements will occur within the VRF device corresponding to the individual networks selected. In this scenario, the pod subnet for blue is advertised over the blue VRF device and the pod subnet for red is advertised over the red VRF device.

When the OVN-Kubernetes controller sees this `RouteAdvertisements` CR, it generates a `FRRConfiguration` object that configures the FRR daemon to advertise the routes for the blue and red tenants.

.`FRRConfiguration` CR generated by OVN-Kubernetes for blue and red tenants
[source,yaml]
----
apiVersion: frrk8s.metallb.io/v1beta1
kind: FRRConfiguration
metadata:
  name: route-advertisements-blue
  namespace: metallb-system
spec:
  bgp:
    routers:
    - asn: 64512
      neighbors:
      - address: 182.18.0.5
        asn: 64512
        toAdvertise:
          allowed:
            prefixes:
            - 10.0.1.0/24
      vrf: blue
      prefixes:
        - 10.0.1.0/24
    - asn: 64512
      neighbors:
      - address: 192.18.0.5
        asn: 64512
        toAdvertise:
          allowed:
            prefixes:
            - 10.0.1.0/24
      vrf: red
      prefixes:
         - 10.0.1.0/24
  nodeSelector:
     matchLabels:
        kubernetes.io/hostname: ovn-worker
----

In this scenario, any filtering or selection of routes to receive must be done in the `FRRConfiguration` CR that defines peering relationships.

[role="_additional-resources"]
[id="additional-resources_about-bgp-routing"]
== Additional resources

- xref:../../networking/multiple_networks/understanding-user-defined-network.adoc#understanding-user-defined-networks[Understanding user-defined networks]

- link:https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/8/html/configuring_and_managing_networking/assembly_starting-a-service-within-an-isolated-vrf-network_configuring-and-managing-networking[Starting a service within an isolated VRF network]

- link:https://docs.frrouting.org/en/latest/bgp.html[FRRouting User Guide: BGP]
